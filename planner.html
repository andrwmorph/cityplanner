<html>
<head>
	<title>City Planner</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<style type="text/css">
			.plannerbody { text-align: center; }
			.blocktype { display: inline-block;
						 font-size: larger;
		   				 padding: 10px; }
			.buildingtable { width: 600px; }
			.btright { text-align: left; 
			 		   vertical-align: middle; }
			.btleft { text-align: right; 
			 		   vertical-align: middle; }
			.radio {display: none; }
	</style>
</head>
<body>
<div class="plannerbody">
<canvas id="canvas" height=450 width=600>Your browser does not support the HTML5 canvas tag.</canvas>

<script>
var blockSize=40;
var padding=2;
var grids=11;
var blocks = new Array(grids);
var gridSize=blockSize*grids;
var canvasMinX;
var canvasMaxX;
var canvasMinY;
var canvasMaxY;
var clickedBlock;

//Initialize mouse stuff
function init_mouse() {
	WIDTH = $("#canvas").width()
	HEIGHT = $("#canvas").height()
	canvasMinX = $("#canvas").offset().left;
	canvasMaxX = canvasMinX + WIDTH;
	canvasMinY = $("#canvas").offset().top;
	canvasMaxY = canvasMinX + HEIGHT;
}

//Mouse click processing
function onMouseClick(evt) {
	if (evt.pageX > canvasMinX && evt.pageX < canvasMaxX && evt.pageY > canvasMinY && evt.pageY < canvasMaxY) {
		if (blockClicked(evt.offsetX, evt.offsetY)) {
			if(document.getElementById('type_Farm').checked) {
				changeClickedBlock(BLOCKTYPE.FARM);
			}else if(document.getElementById('type_Barracks').checked) {
				changeClickedBlock(BLOCKTYPE.BARRACKS);
			}else if(document.getElementById('type_Road').checked) {
				changeClickedBlock(BLOCKTYPE.ROAD);
			}else if(document.getElementById('type_BS').checked) {
				changeClickedBlock(BLOCKTYPE.BS);
			}else if(document.getElementById('type_Armory').checked) {
				changeClickedBlock(BLOCKTYPE.ARMORY);
			}else if(document.getElementById('type_Foundry').checked) {
				changeClickedBlock(BLOCKTYPE.FOUNDRY);
			}else if(document.getElementById('type_Market').checked) {
				changeClickedBlock(BLOCKTYPE.MARKET);
			}else if(document.getElementById('type_Refinery').checked) {
				changeClickedBlock(BLOCKTYPE.REFINERY);
			}else if(document.getElementById('type_Basement').checked) {
				changeClickedBlock(BLOCKTYPE.BASEMENT);
			}else if(document.getElementById('type_Tower').checked) {
				changeClickedBlock(BLOCKTYPE.TOWER);
			}else if(document.getElementById('type_TP').checked) {
				changeClickedBlock(BLOCKTYPE.TP);
			}else if(document.getElementById('type_University').checked) {
				changeClickedBlock(BLOCKTYPE.UNIVERSITY);
			}else if(document.getElementById('type_Stables').checked) {
				changeClickedBlock(BLOCKTYPE.STABLES);
			}else if(document.getElementById('type_Delete').checked) {
				deleteClickedBlock();
			}
		}
  	}
}

//Mouse is processed on the entire page
$('#canvas').click(onMouseClick);

//Enum
var BLOCKTYPE = {
	NULL : {value: 0, name: "Null", size: 1, color: "#000000"}, 
	EMPTY : {value: 1, name: "Empty", size: 1, color: "#CCCCCC"}, 
	TC: {value: 2, name: "Town Center", size: 3, color: "#AA3030"}, 
	FARM: {value: 3, name: "Farm", size: 1, color: "#00AA00"},
	BARRACKS: {value: 4, name: "Barracks", size: 2, color: "#0000AA"},
	ROAD: {value: 5, name: "Road", size: 1, color: "#333333"}, 
	BS: {value: 6, name: "Blacksmith", size: 1, color: "#00AAAA"},
	ARMORY: {value: 7, name: "Armory", size: 1, color: "#AA00AA"},
	FOUNDRY: {value: 8, name: "Foundry", size: 1, color: "#AAAA00"},
	MARKET: {value: 9, name: "Market", size: 1, color: "#FFAA00"},
	REFINERY: {value: 10, name: "Refinery", size: 1, color: "#663300"},
	BASEMENT: {value: 11, name: "Basement", size: 1, color: "#00FFAA"},
	TOWER: {value: 12, name: "Tower", size: 1, color: "#FF0000"},
	TP: {value: 13, name: "Trading Post", size: 2, color: "#CCCC00"},
	UNIVERSITY: {value: 14, name: "University", size: 2, color: "#CC00FF"},
	STABLES: {value: 15, name: "Stables", size: 2, color: "#003300"}
};

//Returns the block type from the value number
function getBlocktype(blockval) {
	for (var x in BLOCKTYPE) {
		var blk = BLOCKTYPE[x];
		if (blk.value == blockval) {
			//document.write(BLOCKTYPE[i]);
			return blk;
			}
	}
}

//Block constructor
function block(type, i, j)
{
	this.type = type;
	this.size = type.size * blockSize;
	this.i = i
	this.j = j
	this.x = i*blockSize
	this.y = j*blockSize
	this.isClicked = function(x, y) {
		if (this.x < x && this.x + this.size > x && this.y < y && this.y + this.size > y) {
			return true;
		} else {
			return false;
		}
	}
	this.toString = function() {
		return "{ \"type\": " + this.type.value + ", \"i\": " + this.i + ", \"j\": " +  this.j + " }";
		
	}
}

//Changes the block type of blocks[i][j]
function changeBlock(i, j, type) {
	if (type.size == 2 ) {
		if (blocks[i+1][j].type.value != 1 || blocks[i][j+1].type.value != 1 || blocks[i+1][j+1].type.value != 1) {
			return false
		}	
	}
	blocks[i][j] = new block(type, i, j);
	if (type.size > 1) { 
		changeBlock(i + 1, j, BLOCKTYPE.NULL); 
		changeBlock(i, j + 1, BLOCKTYPE.NULL); 
		changeBlock(i + 1, j + 1,  BLOCKTYPE.NULL); 
	}
	if (type.size == 3) { 
		changeBlock(i + 2, j, BLOCKTYPE.NULL); 
		changeBlock(i + 2, j + 1, BLOCKTYPE.NULL); 
		changeBlock(i, j + 2, BLOCKTYPE.NULL); 
		changeBlock(i + 1, j + 2, BLOCKTYPE.NULL); 
		changeBlock(i + 2, j + 2, BLOCKTYPE.NULL); 
	}
	drawGrid()
}

//Deletes the clicked block
function deleteClickedBlock() {
	if (clickedBlock.type.value != 2) {
		var i = clickedBlock.i; var j = clickedBlock.j;
		if (clickedBlock.type.size > 1) { 
			changeBlock(i + 1, j, BLOCKTYPE.EMPTY); 
			changeBlock(i, j + 1, BLOCKTYPE.EMPTY); 
			changeBlock(i + 1, j + 1,  BLOCKTYPE.EMPTY); 
		}
		changeBlock(clickedBlock.i, clickedBlock.j, BLOCKTYPE.EMPTY);
	}
}

//Changes the clicked block type
function changeClickedBlock(type) {
	if (clickedBlock.type.value == 1) {
		changeBlock(clickedBlock.i, clickedBlock.j, type);
	} else if (clickedBlock.type.value == type.value) {
		deleteClickedBlock();
	}
}

//Checks all the blocks to see if they were clicked
function blockClicked(x, y) {
	for (var i=0;i<grids;i++) {
		for (var j=0;j<grids;j++) {
			if (blocks[i][j].isClicked(x, y)) {
				if (blocks[i][j].type.value != 0) { 
					clickedBlock=blocks[i][j];
					return true;
				}
			}
		}
	}	
	return false;
}

//Initialize grid
function init() {
	for (var i=0;i<grids;i++) {
		blocks[i] = new Array(grids)
		for (var j=0;j<grids;j++) {
			blocks[i][j] = new block(BLOCKTYPE.EMPTY, i, j);
		}
	}
	changeBlock(4,4,BLOCKTYPE.TC);
}

//Draws the grid
function drawGrid() {
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.fillStyle='#EEEEEE';
	ctx.fillRect(0,0,gridSize,gridSize);
	for (var i=0;i<grids;i++) {
		for (var j=0;j<grids;j++) {
			var current_type=blocks[i][j].type;
			if (current_type.value != 0 ) {
				var current_size=blocks[i][j].size;
				var x=blocks[i][j].x
				var y=blocks[i][j].y
				ctx.fillStyle=current_type.color;
				if (current_type.value != 5 ) {
					ctx.fillRect(x + padding,y + padding,current_size - padding,current_size - padding);
				} else {	
					ctx.fillRect(x + (padding / 2), y + (padding / 2), current_size,current_size);
				}
			}
	 	}		
	}
	drawKey()
}

//Counts the number of blocks of a certain type
function countBlocks(type) {
	count=0;	
	for (var i=0;i<grids;i++) {
		for (var j=0;j<grids;j++) {
			if (blocks[i][j].type.value == type.value) { count++; }
		}
	}
	return count;
}

//Draw colored labels to the right of the grid
function drawKey () {
	ctx.font="20px Georgia";
	var y = 20;
	for (var x in BLOCKTYPE) {
		var blk = BLOCKTYPE[x];
		if (blk.value != 0 && blk.value != 1) {
			count=countBlocks(blk);	
			ctx.fillStyle = blk.color;
			ctx.fillText(count + " - " + blk.name,gridSize + 10,y);
			y += 30;
		}
	}
}

//Export a JSON of the blocks
function exportGrid () {
	var output = "["
	var b
	for (var i=0;i<grids;i++) {
		for (var j=0;j<grids;j++) {
			b = blocks[i][j];
			if (b.type.value != 0 && b.type.value != 1) {
				output += b.toString() + ",";
			}
		}
	}
	output = output.substring(0, output.length - 1);
	output += "]";
	document.getElementById('saveField').value = output;
	var outLink = '<a href="' + document.URL + "?layout=" + encodeURIComponent(output) + '">Saved Layout</a>';
	document.getElementById('savelink').innerHTML = outLink;
}

//Recreate the blocks from the JSON string
function importGrid () {
	//init()
	urlparam = location.search.split('layout=')[1];
	if (urlparam) {
		var input = JSON.parse(decodeURIComponent(urlparam))
		//input = JSON.parse(decodeURIComponent(document.getElementById('saveField').value));
		//document.write(input[0].type)
		for (var x=0; x < input.length; x++) {
			blocktype=getBlocktype(input[x].type);
			//document.write(blocktype);
			changeBlock(input[x].i, input[x].j, blocktype);
		}
	}

}

function importJSONGrid () {
	init()
	var input = JSON.parse(decodeURIComponent(urlparam))
	input = JSON.parse(decodeURIComponent(document.getElementById('saveField').value));
	for (var x=0; x < input.length; x++) {
		blocktype=getBlocktype(input[x].type);
		changeBlock(input[x].i, input[x].j, blocktype);
	}
}


function clickBlocktype(radio, blocktype) {
	$('.blocktype').css('color','black');
	$('.blocktype').css('fontWeight','normal');
	blocktype.style.color = "blue";
	blocktype.style.fontWeight = "bold";
	document.getElementById(radio).checked = true;
}

function changeBackground(div, color) {
	div.style.backgroundColor = color;
}

var c=document.getElementById('canvas');
var ctx=c.getContext('2d');
init()
importGrid()
init_mouse()

</script>
<div>
	<table class="buildingtable" align="center">
		<tr>
			<td class="btleft">
				<div class="blocktype">1v1:</div>
			</td>
			<td class="btright">
				<input class='radio' type="radio" checked name="type" id="type_Road" value="Road" /><div class="blocktype" onClick="clickBlocktype('type_Road',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Road</div>
				<input class='radio' type="radio" name="type" id="type_BS" value="BS" /><div class="blocktype" onClick="clickBlocktype('type_BS',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Blacksmith</div>
				<input class='radio' type="radio" name="type" id="type_Armory" value="Armory" /><div class="blocktype" onClick="clickBlocktype('type_Armory',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Armory</div>
				<input class='radio' type="radio" name="type" id="type_Foundry" value="Foundry" /><div class="blocktype" onClick="clickBlocktype('type_Foundry',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Foundry</div>
				<input class='radio' type="radio" name="type" id="type_Market" value="Market" /><div class="blocktype" onClick="clickBlocktype('type_Market',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Market</div><br>
				<input class='radio' type="radio" name="type" id="type_Refinery" value="Refinery" /><div class="blocktype" onClick="clickBlocktype('type_Refinery',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Refinery</div>
				<input class='radio' type="radio" name="type" id="type_Basement" value="Basement" /><div class="blocktype" onClick="clickBlocktype('type_Basement',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Basement</div>
				<input class='radio' type="radio" name="type" id="type_Tower" value="Tower" /><div class="blocktype" onClick="clickBlocktype('type_Tower',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Tower</div>
				<input class='radio' type="radio" name="type" id="type_Farm" value="Farm" /><div class="blocktype" onClick="clickBlocktype('type_Farm',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Farm</div>
			</td>
		</tr>
		<tr>
			<td class="btleft">
				<br><div class="blocktype">2x2:</div>
			</td>
			<td class="btright">
				<input class="radio" type="radio" name="type" id="type_Barracks" value="Barracks" /><div class="blocktype" onClick="clickBlocktype('type_Barracks',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Barracks</div>
				<input class="radio" type="radio" name="type" id="type_TP" value="TP" /><div class="blocktype" onClick="clickBlocktype('type_TP',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Trading Post</div>
				<input class="radio" type="radio" name="type" id="type_University" value="University" /><div class="blocktype" onClick="clickBlocktype('type_University',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">University</div>
				<input class="radio" type="radio" name="type" id="type_Stables" value="Stables" /><div class="blocktype" onClick="clickBlocktype('type_Stables',this)" onMouseOver="changeBackground(this,'grey')" onMouseOut="changeBackground(this, 'white')">Stables</div>
			</td>
		</tr>
		<tr>
			 <td colspan=2 style="text-align:center">
				<input class="radio" type="radio" name="type" id="type_Delete" value="Delete" /><div class="blocktype" onClick="clickBlocktype('type_Delete',this)" onMouseOver="changeBackground(this,'red')" onMouseOut="changeBackground(this, 'white')">Delete</div>
			</td>
		</tr>
	</table>
	<br>
	<button type="Button" onClick='init()'>Reset</button>
	<button type="Button" onClick='exportGrid()'>Save</button>
	<button type="Button" onClick='importJSONGrid()'>Load</button>
	<br>
	<div id="savelink"></div>
	<textarea rows="4" cols="50" id="saveField">Copy and paste the generated JSON to share/save a layout</textarea>
</div>
</div>
</body>

</html>
